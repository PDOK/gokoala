---
name: e2e-test
on:
  pull_request:
jobs:
  # These are all tests/validations against a live GoKoala instance
  end-to-end-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Build a local test image for (potential) re-use across end-to-end tests
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker
      - name: Build test image
        uses: docker/build-push-action@v6
        with:
          push: false
          load: true  # expose to Docker
          tags: gokoala:local

      # Now we can start the test instance
      - name: Start GoKoala test instance
        run: |
          docker run \
            -v `pwd`/examples:/examples \
            --rm --detach -p 8080:8080 \
            --name gokoala \
            gokoala:local --config-file /examples/config_all.yaml

      # E2E Test (Cypress)
      - name: E2E Test => Cypress
        uses: cypress-io/github-action@v6
        with:
          working-directory: ./tests
          browser: chrome

      # E2E Test (OWSLib)
      - name: E2E Test => OGC API Features query using Python (OWSLib)
        run: |
          docker run --net=host -t \
            -v `pwd`/examples:/examples \
            docker.io/python:3.13-slim \
            sh -c "pip install --no-cache-dir OWSLib && python /examples/client.py"

      # E2E Test (GDAL)
      - name: E2E Test => OGC API Features query using GDAL
        run: |
          docker run --net=host -t \
            -v `pwd`/examples:/examples \
            ghcr.io/osgeo/gdal:ubuntu-small-3.8.3 \
            sh -c "ogrinfo -so OAPIF:http://localhost:8080 addresses"

      # E2E Test (Features conformance)
      - name: E2E Test => OGC API Features Conformance Validation
        run: |
          sleep 5
          docker run --net=host -t -v "$(pwd):/mnt" \
            docker.io/pdok/ets-ogcapi-features10-docker:latest \
            http://localhost:8080 \
            --generateHtmlReport true \
            --outputDir /mnt/output \
            --exitOnFail \
            --prettyPrint

      # E2E Test (Tiles conformance)
      - name: E2E Test => OGC API Tiles Conformance Validation
        run: |
          sleep 5
          docker run --net=host -t -v "$(pwd):/mnt" \
            docker.io/pdok/ets-ogcapi-tiles10-docker:latest \
            http://localhost:8080 \
            --generateHtmlReport true \
            --outputDir /mnt/output \
            --exitOnFail \
            --prettyPrint

      # Stop test instance, the tests below don't need it since they use Docker Compose
      - name: Stop GoKoala test instance
        run: |
          docker stop gokoala

      # E2E Test (API Design Rules conformance)
      - name: E2E Test => API Design Rules validation (linting)
        run: |
          docker compose -f ./tests/adr/docker-compose.yaml up \
            --exit-code-from adr-linter

      # E2E Test (Cloud-Backed GeoPackage)
      - name: E2E Test => OGC API Features with Azure hosted GeoPackage backend
        run: |
          docker compose -f ./examples/docker-compose-features-azure.yaml up \
            --exit-code-from smoketest

      # E2E Test (Features Search)
      - name: E2E Test => Features Search with Postgres backend
        run: |
          docker compose -f ./examples/docker-compose-features-search.yaml up -d postgres

          # This runs the ETL container, waits for it to finish, and removes it
          docker compose -f ./examples/docker-compose-features-search.yaml run --rm gokoala-etl

          # Now start the rest (server + smoketest). Since ETL is already done, it won't trigger an abort
          docker compose -f ./examples/docker-compose-features-search.yaml up \
            --exit-code-from smoketest
